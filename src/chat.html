<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MoveON - Chat</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="../src/css/chat.css" />
  <link rel="stylesheet" href="../src/css/style.css" />
  <link rel="stylesheet" href="../src/css/Josh.Reset/Reset.css" />
  <link rel="stylesheet" href="../src/css/output.css" />

  <link rel="icon" href="../img/logos/favicon.ico" type="image/x-icon" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Khand:wght@300;400;500;600;700&family=Raleway:wght@100..900&display=swap" rel="stylesheet" />

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <a href="amigos.html" class="back-btn-header" aria-label="Voltar para a lista de amigos">
        <ion-icon name="arrow-back-outline"></ion-icon>
        Voltar
      </a>
      <h2 id="friend-name">Carregando...</h2>
    </div>

    <div class="chat-messages" aria-live="polite"></div>

    <form class="chat-input" autocomplete="off" aria-label="Enviar mensagem">
      <input type="text" placeholder="Digite sua mensagem..." aria-label="Campo de mensagem" autofocus />
      <button type="submit" aria-label="Botão de envio">
        <ion-icon name="send-outline"></ion-icon>
        Enviar
      </button>
    </form>
  </div>

  <div id="overlay" class="overlay" style="display:none;"></div>
  <div id="editPopup" class="edit-popup" style="display:none;">
    <textarea id="editMessageInput"></textarea>
    <div class="buttons">
      <button class="delete-btn">Excluir</button>
      <button class="cancel-btn">Cancelar</button>
      <button class="save-btn">Salvar</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const amigoId = params.get('amigo_id');
      const amigoNome = params.get('amigo_nome');
      const usuarioId = localStorage.getItem('usuario_id');

      if (!amigoId || !usuarioId) {
        alert('Dados do chat inválidos. Volte e tente novamente.');
        window.location.href = 'amigos.html';
        return;
      }

      document.getElementById('friend-name').textContent = decodeURIComponent(amigoNome);

      const mensagensContainer = document.querySelector('.chat-messages');
      const inputMensagem = document.querySelector('.chat-input input');

      const editPopup = document.getElementById('editPopup');
      const overlay = document.getElementById('overlay');
      const editMessageInput = document.getElementById('editMessageInput');
      const saveBtn = editPopup.querySelector('.save-btn');
      const cancelBtn = editPopup.querySelector('.cancel-btn');
      const deleteBtn = editPopup.querySelector('.delete-btn');

      let mensagemIdSelecionada = null;

      function abrirPopupEditar(conteudo, id) {
        mensagemIdSelecionada = id;
        editMessageInput.value = conteudo;
        editPopup.style.display = 'block';
        overlay.style.display = 'block';
      }

      function fecharPopup() {
        editPopup.style.display = 'none';
        overlay.style.display = 'none';
        mensagemIdSelecionada = null;
      }

      saveBtn.addEventListener('click', async () => {
        const novoConteudo = editMessageInput.value.trim();
        if (!mensagemIdSelecionada || novoConteudo === '') return;

        const res = await fetch(`http://localhost:3000/api/mensagens/${mensagemIdSelecionada}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ conteudo: novoConteudo })
        });

        if (res.ok) {
          fecharPopup();
          await carregarMensagens();
        } else {
          alert('Erro ao editar mensagem.');
        }
      });

      cancelBtn.addEventListener('click', () => {
        fecharPopup();
      });

      deleteBtn.addEventListener('click', async () => {
        if (!mensagemIdSelecionada) return;
        const confirmacao = confirm('Tem certeza que deseja excluir esta mensagem?');
        if (!confirmacao) return;

        const res = await fetch(`http://localhost:3000/api/mensagens/${mensagemIdSelecionada}`, {
          method: 'DELETE',
        });

        if (res.ok) {
          fecharPopup();
          await carregarMensagens();
        } else {
          alert('Erro ao excluir mensagem.');
        }
      });

      async function carregarMensagens() {
        try {
          const response = await fetch(`http://localhost:3000/api/mensagens?usuario1=${usuarioId}&usuario2=${amigoId}`);
          if (!response.ok) throw new Error('Erro ao carregar mensagens');

          const mensagens = await response.json();
          mensagensContainer.innerHTML = '';

          mensagens.forEach(msg => {
            const div = document.createElement('div');
            div.classList.add('message', msg.remetente_id == usuarioId ? 'sent' : 'received');

            div.innerHTML = `
              <div class="bubble" data-id="${msg.id}" data-conteudo="${msg.conteudo}">
                <p>${msg.conteudo}</p>
                <span class="timestamp">${formatarHora(msg.criado_em)}</span>
              </div>
            `;

            if (msg.remetente_id == usuarioId) {
              div.querySelector('.bubble').addEventListener('click', () => {
                abrirPopupEditar(msg.conteudo, msg.id);
              });
            }

            mensagensContainer.appendChild(div);
          });

          mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
        } catch (err) {
          console.error(err);
          mensagensContainer.innerHTML = '<p>Erro ao carregar mensagens.</p>';
        }
      }

      function formatarHora(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      await carregarMensagens();

      document.querySelector('.chat-input').addEventListener('submit', async (e) => {
        e.preventDefault();
        const conteudo = inputMensagem.value.trim();
        if (!conteudo) return;

        try {
          const response = await fetch('http://localhost:3000/api/mensagens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              remetente_id: usuarioId,
              destinatario_id: amigoId,
              conteudo
            }),
          });

          if (!response.ok) throw new Error('Erro ao enviar mensagem');

          inputMensagem.value = '';
          await carregarMensagens();
        } catch (err) {
          alert('Erro ao enviar mensagem, tente novamente.');
          console.error(err);
        }
      });

      setInterval(carregarMensagens, 5000);
    });
  </script>
</body>
</html>
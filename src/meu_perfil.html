<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoveON - Meu Perfil</title>

  <!-- Favicon -->
  <link rel="icon" href="../img/logos/favicon.ico" type="image/x-icon" />

  <!-- CSS -->
  <link rel="stylesheet" href="../src/css/Josh.Reset/Reset.css" />
  <link rel="stylesheet" href="../src/css/meu_perfil.css" />
  <link rel="stylesheet" href="../src/css/style.css" />
  <link rel="stylesheet" href="../src/css/output.css" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Khand:wght@300;400;500;600;700&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />

  <!-- Ionicons -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<body>
  <!-- Botão de Voltar -->
  <div class="back-button">
    <a href="../index.html"><ion-icon name="arrow-back-outline" class="icon"></ion-icon> Voltar</a>
  </div>

  <!-- Meu Perfil -->
  <div class="profile-container">
    <div class="profile-picture">
      <ion-icon name="person-circle-outline" class="user-icon"></ion-icon>
      <ion-icon name="create-outline" class="edit-photo-icon"></ion-icon>
    </div>
    <div class="profile-info">
      <p><strong>Nome:</strong> <span id="nome-texto">[user-name]</span> 
        <ion-icon name="create-outline" class="edit-icon" data-campo="nome"></ion-icon>
      </p>
      <p><strong>Email:</strong> <span id="email-texto">useremail@exemplo.com</span> 
        <ion-icon name="create-outline" class="edit-icon" data-campo="email"></ion-icon>
      </p>
      <p><strong>Senha:</strong> <span id="senha-texto">********</span> 
        <ion-icon name="create-outline" class="edit-icon" data-campo="senha"></ion-icon>
      </p>
      <button class="deletar-btn"><strong>EXCLUIR CONTA</strong></button>
    </div>
  </div>

  <!-- Tags -->
  <div class="tags-container">
    <h2>Esportes e Atividades Físicas</h2>
    <form>
      <label for="tags">Adicione seus esportes e atividades físicas:</label>
      <input type="text" id="tags" name="tags" placeholder="Ex: Futebol, Corrida, Yoga" />
      <button type="submit">Adicionar</button>
    </form>
    <div class="tags-list"></div>
  </div>

  <!-- Minhas Postagens -->
  <div class="meus-posts-container">
    <h2>Minhas Postagens</h2>
    <div id="meus-posts" class="lista-posts"></div>
  </div>

  <!-- Scripts -->
  <script>
    const usuarioId = localStorage.getItem('usuario_id');
    const usuarioNome = localStorage.getItem('usuario_nome');
    const usuarioEmail = localStorage.getItem('usuario_email');

    document.addEventListener('DOMContentLoaded', () => {
      // Exibir dados
      document.getElementById('nome-texto').textContent = usuarioNome || '[Sem nome]';
      document.getElementById('email-texto').textContent = usuarioEmail || '[Sem email]';

      // Editar nome, email e senha
      document.querySelectorAll('.edit-icon').forEach(icon => {
        icon.addEventListener('click', () => {
          const campo = icon.getAttribute('data-campo');
          const span = document.getElementById(`${campo}-texto`);
          const valorAtual = campo === 'senha' ? '' : span.textContent;
          if (span.querySelector('input')) return;

          const input = document.createElement('input');
          input.type = campo === 'senha' ? 'password' : 'text';
          input.value = valorAtual;
          input.placeholder = campo === 'senha' ? 'Nova senha' : '';
          input.classList.add('input-editar');

          const botao = document.createElement('button');
          botao.textContent = '✔️';
          botao.style.marginLeft = '8px';

          span.textContent = '';
          span.appendChild(input);
          span.appendChild(botao);

          botao.addEventListener('click', async () => {
            const novoValor = input.value.trim();
            if (!novoValor) return alert('Preencha o campo.');

            const dados = {
              nome: campo === 'nome' ? novoValor : localStorage.getItem('usuario_nome'),
              email: campo === 'email' ? novoValor : localStorage.getItem('usuario_email'),
              senha: campo === 'senha' ? novoValor : undefined
            };

            try {
              const resposta = await fetch(`http://localhost:3000/api/usuarios/${usuarioId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
              });

              const resultado = await resposta.json();

              if (resposta.ok) {
                alert(`${campo} atualizado com sucesso!`);
                if (campo !== 'senha') {
                  span.textContent = novoValor;
                  localStorage.setItem(`usuario_${campo}`, novoValor);
                } else {
                  span.textContent = '********';
                }
              } else {
                alert('Erro: ' + (resultado.mensagem || resultado.erro));
                span.textContent = valorAtual;
              }
            } catch {
              alert('Erro ao conectar com o servidor.');
              span.textContent = valorAtual;
            }
          });
        });
      });

      // Excluir conta
      document.querySelector('.deletar-btn').addEventListener('click', async () => {
        if (!confirm('Tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita.')) return;

        try {
          const res = await fetch(`http://localhost:3000/api/usuarios/${usuarioId}`, { method: 'DELETE' });
          const json = await res.json();

          if (res.ok) {
            alert('Conta excluída com sucesso!');
            localStorage.clear();
            window.location.href = 'entrar.html';
          } else {
            alert('Erro ao excluir conta: ' + (json.mensagem || json.erro));
          }
        } catch {
          alert('Erro ao conectar com o servidor.');
        }
      });

      carregarTags();
      carregarMinhasPostagens();
    });

    // TAGS
    async function carregarTags() {
      const tagsList = document.querySelector('.tags-list');
      tagsList.innerHTML = 'Carregando...';

      try {
        const res = await fetch(`http://localhost:3000/api/usuario-atividades/${usuarioId}`);
        const tags = await res.json();
        tagsList.innerHTML = '';
        tags.forEach(tag => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = tag.nome;
          span.dataset.atividadeId = tag.id;
          span.style.cursor = 'pointer';

          span.addEventListener('click', async () => {
            if (!confirm(`Remover "${tag.nome}" do seu perfil?`)) return;
            const delRes = await fetch('http://localhost:3000/api/usuario-atividades/remover', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ usuario_id: usuarioId, atividade_id: tag.id })
            });

            if (delRes.ok) {
              span.remove();
              alert('Atividade removida!');
            } else {
              const json = await delRes.json();
              alert('Erro ao remover: ' + (json.mensagem || json.erro));
            }
          });

          tagsList.appendChild(span);
        });
      } catch {
        tagsList.textContent = 'Erro ao carregar atividades.';
      }

      document.querySelector('form').addEventListener('submit', async e => {
        e.preventDefault();
        const input = document.getElementById('tags');
        const texto = input.value.trim();
        if (!texto) return alert('Digite ao menos uma atividade.');

        const nomes = texto.split(',').map(n => n.trim()).filter(Boolean);

        try {
          const resAtividades = await fetch('http://localhost:3000/api/atividades');
          const todas = await resAtividades.json();

          for (const nome of nomes) {
            const existente = todas.find(a => a.nome.toLowerCase() === nome.toLowerCase());
            if (!existente) {
              alert(`Atividade "${nome}" não encontrada.`);
              continue;
            }

            const resAdd = await fetch('http://localhost:3000/api/usuario-atividades/adicionar', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ usuario_id: usuarioId, atividade_id: existente.id })
            });

            if (resAdd.ok) {
              const nova = document.createElement('span');
              nova.className = 'tag';
              nova.textContent = existente.nome;
              nova.dataset.atividadeId = existente.id;
              tagsList.appendChild(nova);
            } else {
              const json = await resAdd.json();
              alert(`Erro: ${json.mensagem || json.erro}`);
            }
          }

          input.value = '';
        } catch {
          alert('Erro ao conectar com o servidor.');
        }
      });
    }

    // POSTAGENS
    async function carregarMinhasPostagens() {
      const container = document.getElementById('meus-posts');
      container.innerHTML = 'Carregando...';

      try {
        const res = await fetch(`http://localhost:3000/api/postagens/usuario/${usuarioId}`);
        const postagens = await res.json();
        container.innerHTML = '';

        if (postagens.length === 0) {
          container.innerHTML = '<p>Você ainda não criou nenhuma postagem.</p>';
          return;
        }

        postagens.forEach(post => {
          console.log(post);
          const div = document.createElement('div');
          div.className = 'card-post';
          div.innerHTML = `
            <div class="conteudo">
              <p class="texto-post">${post.conteudo}</p>
            </div>
            <div class="acoes">
              <button class="editar">Editar</button>
              <button class="deletar">Excluir</button>
            </div>
          `;

          div.querySelector('.deletar').addEventListener('click', async () => {
            if (!confirm('Deseja excluir esta postagem?')) return;
            const resp = await fetch(`http://localhost:3000/api/postagens/${post.id}`, { method: 'DELETE' });
            if (resp.ok) {
              div.remove();
              alert('Postagem excluída!');
            } else {
              alert('Erro ao excluir.');
            }
          });

          div.querySelector('.editar').addEventListener('click', async () => {
          const p = div.querySelector('.texto-post');
          const textoAtual = p.textContent;
          const novoTexto = prompt('Editar texto da postagem:', textoAtual);

          if (novoTexto && novoTexto.trim()) {
            const resposta = await fetch(`http://localhost:3000/api/postagens/${post.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ conteudo: novoTexto.trim() }) // <-- AQUI!
            });

            if (resposta.ok) {
              p.textContent = novoTexto.trim();
              alert('Texto atualizado!');
            } else {
              alert('Erro ao atualizar.');
            }
          }
        });
        
          container.appendChild(div);
        });
      } catch {
        container.innerHTML = '<p>Erro ao carregar postagens.</p>';
      }
    }
  </script>
</body>
</html>